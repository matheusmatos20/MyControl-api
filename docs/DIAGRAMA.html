<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Diagramas — MyControl API</title>
  <style>
    :root { --bg:#0b1220; --card:#0f172a; --text:#e2e8f0; --muted:#94a3b8; --accent:#38bdf8; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); }
    header { padding: 16px 20px; border-bottom: 1px solid #1f2937; position: sticky; top: 0; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(6px); }
    header h1 { font-size: 18px; margin: 0; }
    main { padding: 14px; max-width: 1100px; margin: 0 auto; }
    section { background: var(--card); border: 1px solid #1f2937; border-radius: 10px; padding: 14px; margin-bottom: 14px; }
    h2 { font-size: 16px; margin: 0 0 8px; color: var(--accent); }
    .note { color: var(--muted); font-size: 13px; margin-bottom: 8px; }
    .mermaid { background: #0b1329; border: 1px solid #1e293b; border-radius: 8px; padding: 6px; overflow-x: auto; }
  </style>
  <script type="module">
    import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";
    mermaid.initialize({ startOnLoad: true, theme: 'dark', securityLevel: 'loose', fontFamily: 'Inter, system-ui, sans-serif' });
  </script>
</head>
<body>
  <header>
    <h1>Diagramas Técnicos — MyControl API</h1>
  </header>
  <main>
    <section>
      <h2>Arquitetura (Visão de Componentes)</h2>
      <p class="note">Front (Views), API (FastAPI), DAL (Model) e Banco (SQL Server).</p>
      <div class="mermaid">
graph TD
  subgraph Browser
    V[Views (HTML/CSS/JS)<br/>app/Views, app/Views_Escala]
    Menu[Menu Lateral]
  end

  V -->|fetch JSON| API[FastAPI<br/>app/main.py]
  Menu --> V

  subgraph API_Layer[API Layer]
    Routes[Rotas + Auth]
    Schemas[Pydantic Schemas<br/>app/Schemas]
  end

  API[API] --> Routes
  Routes --> DAL[DALs<br/>app/Model/*]
  DAL --> DB[(SQL Server)]
      </div>
    </section>

    <section>
      <h2>Modelo de Dados (Módulo Escala)</h2>
      <p class="note">Entidades novas e relacionamentos principais.</p>
      <div class="mermaid">
classDiagram
  class TB_CARGA_HORARIA {
    ID_CARGA_HORARIA: int
    DS_CARGA_HORARIA: string
    QT_HORAS_SEMANAIS: int
  }
  class TB_POSTOS {
    ID_POSTO: int
    NM_POSTO: string
    ID_CARGA_HORARIA: int
    QT_COLABORADORES: int
  }
  class TB_FUNCIONARIOS {
    ID_FUNCIONARIO: int
    NM_FUNCIONARIO: string
  }
  class TB_ESCALA {
    ID_ESCALA: int
    ID_FUNCIONARIO: int
    ID_POSTO: int
    DATA: date
    TURNO: string
    OBSERVACAO: string
    DT_CADASTRO: datetime
  }
  class TB_FOLGAS_FUNCIONARIO {
    ID_FOLGA: int
    ID_FUNCIONARIO: int
    DATA: date
    OBSERVACAO: string
    DT_CADASTRO: datetime
  }

  TB_POSTOS --> TB_CARGA_HORARIA : FK ID_CARGA_HORARIA
  TB_ESCALA --> TB_POSTOS : FK ID_POSTO
  TB_ESCALA --> TB_FUNCIONARIOS : FK ID_FUNCIONARIO
  TB_FOLGAS_FUNCIONARIO --> TB_FUNCIONARIOS : FK ID_FUNCIONARIO
      </div>
    </section>

    <section>
      <h2>Fluxo — Geração de Escala</h2>
      <p class="note">Distribuição justa (round-robin) e alternância 12x36; respeito às folgas.</p>
      <div class="mermaid">
sequenceDiagram
  participant UI as View_Escala
  participant API as FastAPI
  participant DAL as EscalaDAL
  participant DB as SQL Server

  UI->>API: POST /escala/gerar {período, postos?, cargos?}
  API->>DAL: gerar_escala(payload)
  DAL->>DB: SELECT postos, cargas
  DAL->>DB: SELECT colaboradores ativos (último cargo)
  DAL->>DB: SELECT folgas no período
  DAL->>DAL: Round-robin e 12x36 (com folgas)
  DAL->>DB: INSERT TB_ESCALA (lote)
  DAL-->>API: itens inseridos
  API-->>UI: { mensagem, itens }
      </div>
    </section>

    <section>
      <h2>Fluxo — Edição por Célula</h2>
      <p class="note">Consulta por posto/dia; inserção/edição/exclusão.</p>
      <div class="mermaid">
sequenceDiagram
  participant UI
  participant API
  participant DAL
  participant DB

  UI->>API: GET /escala/posto/{id}/data/{data}
  API->>DAL: consultar_escala_posto_dia
  DAL->>DB: SELECT escala JOIN funcionários
  DAL-->>API: lista
  API-->>UI: lista

  UI->>API: POST /escala (célula vazia)
  API->>DAL: inserir_escala_item
  DAL->>DB: INSERT TB_ESCALA
  UI->>API: PUT /escala/{id} (célula com item)
  API->>DAL: atualizar_escala_item
  DAL->>DB: UPDATE TB_ESCALA
  UI->>API: DELETE /escala/{id}
  API->>DAL: excluir_escala
  DAL->>DB: DELETE TB_ESCALA
      </div>

    </section>

    <section>
      <h2>Arquitetura por Assunto — Financeiro</h2>
      <p class="note">Pagamentos, Despesas Fixas, Contas a Receber, Dashboard.</p>
      <div class="mermaid">
graph LR
  subgraph Front
    VF[Views Financeiro<br/>Pagamento, Previsão]
  end
  subgraph API_Layer
    R[Rotas Financeiras]
    PDL[PagamentoDAL]
    FDL[FinanceiroDAL]
    CRDL[ContaReceberDAL]
    DFDL[DespesaFixaDAL]
  end
  DB[(SQL Server)]

  VF --> R
  R --> PDL
  R --> FDL
  R --> CRDL
  R --> DFDL
  PDL --> DB
  FDL --> DB
  CRDL --> DB
  DFDL --> DB
      </div>
    </section>

    <section>
      <h2>Fluxos — Financeiro</h2>
      <p class="note">Processos principais do módulo financeiro.</p>
      <div class="mermaid">
sequenceDiagram
  participant UI as View Pagamentos
  participant API
  participant DAL as PagamentoDAL
  participant DB

  UI->>API: POST /pagamentos/parcelado
  API->>DAL: criar_parcelamento
  DAL->>DB: INSERT parcelas
  DAL-->>API: resumo
  API-->>UI: { mensagem, dados }
      </div>
      <br/>
      <div class="mermaid">
sequenceDiagram
  participant UI as View Despesas Fixas
  participant API
  participant DAL as DespesaFixaDAL
  participant DB

  UI->>API: POST /despesas-fixas/processar {competência}
  API->>DAL: processar_competencia
  DAL->>DB: INSERT lançamentos mês
  DAL-->>API: quantidade
  API-->>UI: { mensagem, quantidade }
      </div>
    </section>
    </section>
  </main>
</body>
</html>
